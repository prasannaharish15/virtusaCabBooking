<!-- Removed problematic global loading overlay -->

<div class="container mx-auto px-4 py-8">
  <div class="max-w-4xl mx-auto">
    <!-- Success Message -->
    <div *ngIf="booking" class="mb-6 bg-green-50 border border-green-200 rounded-lg p-4">
      <div class="flex items-center">
        <svg class="w-6 h-6 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <div>
          <h3 class="text-lg font-semibold text-green-800">Booking Confirmed Successfully!</h3>
          <p class="text-green-600 mt-1">Your ride has been booked and a driver has been assigned.</p>
        </div>
      </div>
    </div>


    <!-- Debug Panel (temporary for troubleshooting) -->
    <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg text-sm">
      <p><strong>ðŸ”§ Debug Info:</strong></p>
      <p>Loading: {{ loading }}</p>
      <p>Booking exists: {{ !!booking }}</p>
      <p>Error: {{ error || 'None' }}</p>
      <p>Booking ID: {{ bookingId }}</p>
      <p>Auto-refresh active: {{ !!refreshSubscription }}</p>
      <button 
        (click)="loadBookingDetails()" 
        class="mt-2 px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">
        Force Reload
      </button>
    </div>

    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900">Booking Details</h1>
      <p class="text-gray-600 mt-2">Booking ID: {{ bookingId }}</p>
    </div>

    <!-- Loading State - Only show if no booking data exists and no error -->
    <div *ngIf="!booking && !error && loading" class="text-center py-12">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto"></div>
      <p class="text-gray-600 mt-4">Loading booking details...</p>
      <p class="text-sm text-gray-500 mt-2">This may take a few seconds...</p>
    </div>

    <!-- No Data State - Show when not loading and no booking data -->
    <div *ngIf="!booking && !error && !loading" class="text-center py-12">
      <div class="text-gray-400 mb-4">
        <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg>
      </div>
      <h3 class="text-lg font-semibold text-gray-700 mb-2">No Booking Data</h3>
      <p class="text-gray-500 mb-4">Unable to load booking information.</p>
      <button 
        (click)="loadBookingDetails()"
        class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
        Retry Loading
      </button>
    </div>

    <!-- Error State -->
    <div *ngIf="error && !loading" class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
      <div class="text-red-600 mb-4">
        <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z"/>
        </svg>
      </div>
      <h3 class="text-lg font-semibold text-red-800 mb-2">Error Loading Booking</h3>
      <p class="text-red-600 mb-4">{{ error }}</p>
      <button 
        (click)="loadBookingDetails()"
        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition mr-2">
        Try Again
      </button>
      <button 
        routerLink="/passenger/bookings"
        class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">
        Back to Bookings
      </button>
    </div>

    <!-- Booking Details - Show if we have booking data, regardless of loading flags -->
    <div *ngIf="booking" class="bg-white rounded-lg shadow-lg overflow-hidden">
      <!-- Status Header -->
      <div class="bg-purple-600 text-white px-6 py-4">
        <div class="flex justify-between items-center">
          <h2 class="text-xl font-bold">Booking #{{ booking.rideId || booking.id }}</h2>
          <span 
            [class]="'px-3 py-1 rounded-full text-sm font-semibold ' + 
            (getStatusColor(booking.status) === 'green' ? 'bg-green-100 text-green-800' :
             getStatusColor(booking.status) === 'yellow' ? 'bg-yellow-100 text-yellow-800' :
             getStatusColor(booking.status) === 'blue' ? 'bg-blue-100 text-blue-800' :
             getStatusColor(booking.status) === 'red' ? 'bg-red-100 text-red-800' :
             'bg-gray-100 text-gray-800')">
            {{ getStatusDisplay(booking.status) }}
          </span>
        </div>
      </div>

      <!-- Booking Content -->
      <div class="p-6">
        <!-- Trip Information -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div>
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Trip Information</h3>
            <div class="space-y-3">
              <div class="flex justify-between">
                <span class="text-gray-600">Pickup:</span>
                <span class="font-medium text-right max-w-xs">
                  {{ booking.pickUpLocation || booking.pickupLocation?.address || 'Not specified' }}
                </span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Destination:</span>
                <span class="font-medium text-right max-w-xs">
                  {{ booking.dropOffLocation || booking.dropLocation?.address || 'Not specified' }}
                </span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Distance:</span>
                <span class="font-medium">{{ (booking.distanceKm || booking.distance || 0).toFixed(1) }} km</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Duration:</span>
                <span class="font-medium">{{ (booking.durationMinutes || booking.estimatedDuration || 0) }} min</span>
              </div>
            </div>
          </div>

          <div>
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Booking Details</h3>
            <div class="space-y-3">
              <div class="flex justify-between">
                <span class="text-gray-600">Cab Type:</span>
                <span class="font-medium">{{ booking.cabType || booking.cab?.name || 'Standard' }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Passengers:</span>
                <span class="font-medium">{{ booking.numberOfCustomers || booking.passengers || 1 }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Ride Type:</span>
                <span class="font-medium">{{ booking.rideType || 'Local' }}</span>
              </div>
              <div class="flex justify-between" *ngIf="booking.driverName">
                <span class="text-gray-600">Driver:</span>
                <span class="font-medium">{{ booking.driverName || 'Not assigned' }}</span>
              </div>
              <div class="flex justify-between" *ngIf="booking.phoneNumber">
                <span class="text-gray-600">Driver Phone:</span>
                <span class="font-medium">{{ booking.phoneNumber }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Fare Details -->
        <div class="border-t pt-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Fare Details</h3>
          <div class="space-y-2">
            <div class="flex justify-between">
              <span class="text-gray-600">Base Fare:</span>
              <span class="font-medium">â‚¹{{ ((booking.fare || booking.totalAmount || 0) * 0.7).toFixed(0) }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Taxes & Charges:</span>
              <span class="font-medium">â‚¹{{ ((booking.fare || booking.totalAmount || 0) * 0.3).toFixed(0) }}</span>
            </div>
            <div class="flex justify-between text-lg font-bold border-t pt-2">
              <span>Total Amount:</span>
              <span class="text-purple-600">â‚¹{{ booking.fare || booking.totalAmount }}</span>
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="border-t pt-6 mt-6">
          <div class="flex gap-4 flex-wrap">
            <button 
              *ngIf="booking.status !== 'CANCELLED' && booking.status !== 'COMPLETED' && booking.status !== 'IN_PROGRESS'"
              (click)="cancelBooking()"
              class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
              [disabled]="loading">
              Cancel Booking
            </button>
            <button 
              routerLink="/passenger/bookings"
              class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">
              Back to Bookings
            </button>
            <button 
              routerLink="/dashboard"
              class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
              Book Another Ride
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>